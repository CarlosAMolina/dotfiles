#!/usr/bin/env bash

set -e # Exit if any command fails.

dry_run="0"

while [[ $# -gt 0 ]]; do
    echo "ARG: \"$1\""
    if [[ "$1" == "--dry" ]]; then
        dry_run="1"
    fi
    shift
done

log() {
    if [[ $dry_run == "1" ]]; then
        echo "[DRY_RUN] $@"
    else
        echo "[DEBUG] $@"
    fi
}

execute() {
    log "execute $@"
    if [[ $dry_run == "1" ]]; then
        return
    fi
    "$@"
}

create_dir() {
    if [ -d "$@" ]; then
        log The "$@" folder already exists
    else
        log The "$@" folder does not exists. Creating
        execute mkdir -p "$@"
    fi
}

run_bsd() {
    # https://github.com/neovim/neovim/blob/master/BUILD.md#build-prerequisites
    execute sudo pkg install cmake gmake wget gettext curl git
    create_dir $HOME/.local/bin
    create_dir $HOME/Software
    execute pushd $HOME/Software > /dev/null
    execute git clone --depth 1 --branch stable https://github.com/neovim/neovim
    execute cd neovim
    execute gmake CMAKE_BUILD_TYPE=Release CMAKE_INSTALL_PREFIX=$HOME/.local/bin/nvim install
    execute popd > /dev/null
}

run_linux() {
    execute sudo apt install -y ripgrep # Required by telescope nvim extension.
    execute pushd /tmp > /dev/null
    execute wget https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.tar.gz
    execute tar -xf nvim-linux-x86_64.tar.gz
    execute sudo install nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
    # https://github.com/vscode-neovim/vscode-neovim/issues/597#issuecomment-1617282040
    execute sudo mkdir -p /usr/local/share/nvim/
    execute sudo cp -r nvim-linux-x86_64/share/nvim/runtime/ /usr/local/share/nvim/
    execute rm -rf nvim-linux-x86_64 nvim.tar.gz
    execute popd > /dev/null
    log Installing vim-plug
    execute sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'

    log Configuring neovim
    execute nvim -c 'PlugInstall'

    log Some manual steps are required
    execute read -p "[DEBUG] Open neovim and execute \`:PlugInstall\`. Press Enter to continue when done" </dev/tty
}

case $(uname) in
  *BSD*)
    run_bsd
    ;;
  *)
    run_linux
    ;;
esac
